name: Déploiement Portfolio (Copie Robuste)

on:
  push:
    branches: [main] 

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    # Étape 1 : Le Runner télécharge le code le plus récent et propre.
    - name: 1. Checkout et Téléchargement du Code
      uses: actions/checkout@v4

    # Étape 2 : Copie le code dans le dossier public d'NGINX.
    - name: 2. Copier les fichiers vers le dossier NGINX
      run: |
        # Attention : utilisez le chemin exact de votre portfolio sur la VM !
        NGINX_ROOT=/var/www/portfolio/deploy-692c765f41b519dbf051548b

        # Vider le dossier de destination (sans supprimer le dossier parent .git s'il existe)
        sudo rm -rf $NGINX_ROOT/*

        # Copie le nouveau code (qui vient d'être téléchargé par checkout@v4) vers le dossier NGINX
        # Le './*' représente le code téléchargé par l'action précédente.
        sudo cp -r ./* $NGINX_ROOT/

        # Réattribution des droits (Sécurité : NGINX doit pouvoir lire les fichiers)
        sudo chown -R www-data:www-data $NGINX_ROOT

        # Tentative de redémarrage NGINX (C'est la ligne qui pourrait encore échouer sans sudoers)
        sudo systemctl restart nginx
